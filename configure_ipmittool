import subprocess

ipmitool = "/usr/bin/ipmitool"
set_ipmitool = "lan set 1"

get_dhcp_static = "IP Address Source"
get_ipaddr = "IP Address"
get_netmask = "Subnet Mask"
get_default_gateway = "Default Gateway IP"

set_ipsrc = "ipsrc"
set_ipaddr = "ipaddr"
set_netmask = "netmask"
set_defgw = "defgw ipaddr"
dhcp = "dhcp"
static = "static"

def get_ipmitool_lan(para):
        """ Get inforamtion on RMM lan """
        ipmi_cmd = ipmitool + " lan print"
        proc = subprocess.Popen(ipmi_cmd.split(), stdout=subprocess.PIPE)
        for line in proc.stdout.readlines():
                if line.startswith(para + "  "):
                        value_str = line.split(":",1)[1]
                        value_str = value_str.split()[0]
                        break
        return value_str

def set_ipmitool_lan(para, valu_para):
        """ Set parameter on RMM lan """
        ipmi_cmd = ipmitool + " lan set 1 " + para + " " + valu_para
        p = subprocess.Popen(ipmi_cmd.split(), stdout=subprocess.PIPE)
        output, err = p.communicate()
        print "out ", output
        print "error ", err


print "DHCP_STATIC = " + str(get_ipmitool_lan(get_dhcp_static))
print "IPADDR = " + str(get_ipmitool_lan(get_ipaddr))
print "NETMASK = " + str( get_ipmitool_lan(get_netmask))
print "DEFULT_GATEWAY = " + str( get_ipmitool_lan(get_default_gateway))

set_ipmitool_lan(set_ipsrc, static)
print "DHCP_STATIC = " + str(get_ipmitool_lan(get_dhcp_static))

set_ipmitool_lan(set_ipsrc, dhcp)
print "DHCP_STATIC = " + str(get_ipmitool_lan(get_dhcp_static))

